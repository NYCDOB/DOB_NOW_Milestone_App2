<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DOB NOW Job Filings</title>  
  <link rel="icon" type="image/png"  href="data/dob_logo.png">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"> 
  <link href="css/styles.css" rel="stylesheet">
  <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" >
  <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css' rel='stylesheet' type='text/css'/>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.12/r-2.1.0/se-1.2.0/datatables.min.css">
  <link href="build/nv.d3.css" rel="stylesheet" type="text/css">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>
<style>


.datasetmsg{
  font-size:14px;
  color:red;
  
  display: none;
  font-weight:bold;
}

    .separator {
        border: 0;
        height: 1px;
        background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
        margin-top: 30px;
     }

    #divCriteriaForm > * {               
        font-size: 18px;
                    
    }

    #desc-text {                      

        width: 600px;
        zpadding-left: 10px;
        padding-top: 20px;
        text-align: center;  
          padding-left: 20px;
          padding-bottom: 5px;

          font-size: 18px;
          font-style: italic;
          color: #002878;
    }

    .desc-text-table-stats{
        font-size: 20px;
        font-style: italic;
        color: #002878;
        float: left;
    }
    #ui-container{
        border: 3px solid black;
        padding: 10px 20px 10px 20px;
        font-size: 18px;
    }
    #table-stats{
        margin-top: 0px;
    }
    #dropdownWT{
        font-size: 18px;
    }

    #geoHeading{
                    font-size: 18px;
                    font-weight: bold;
    }
    #geo-radio{
                    font-size: 15px;
    }
    div.tooltip {
                    color: #222;
                    background: #fff;
                    padding: .5em;
                    text-shadow: #f5f5f5 0 1px 0;
                    border-radius: 7px;
                    box-shadow: 0px 0px 2px 0px #a6a6a6;
                    opacity: 0.9;
                    position: absolute;
                    visibility: hidden;
    }
    #map {
                    position: absolute;
                    height:100%;
                    width: 100%;
                    background-color: #333;
    }
    #map-container{
                    position: relative;
                    display: block;
                    border: 3px solid black;
                    zmin-height: 786px;
                    height: 800px;
                    

    }

    #mapBtn{
                    padding: 5px 5px 5px 5px;
                    background: #46A6DD;
                    color: white;
                    font-size: 18px;
                    font-weight: bold;
                   

    }
    #mapBtn:hover{
                    background: #002878;
    }
    #btnIndFilings_container{
                    padding-right: -50px;
    }
    .btn-dark{
                    color: white;
                    background-color: #46A6DD;
                    border-color: white;
                    font-weight: bold;
    }
    .btn-dark:hover, .btn-dark:focus, .btn-dark:active, .btn-dark.active, .open>.dropdown-toggle.btn-dark{
                    color: white;
                    background-color: #002878;
                    font-weight: bold;
    }
    .ui-autocomplete{
          max-height: 200px;
          overflow-y: auto;
          /* prevent horizontal scrollbar */
          overflow-x: hidden;
          /* add padding to account for vertical scrollbar */
          padding-right: 20px;          
    }
    
    .pagination {
      display: inline-block;
      margin-top: 5px;
    }

    .point{
                    fill: #E64C00;
                    fill-opacity: .7;
                    pointer-events: all;
    }             
    .polyline{
                    pointer-events: none;
    }
    #filingsTable{
                    font-size: 12px;

                    /* overflow-y:auto;  */ /*  CONTROL THE VERTICAL SIZE OF THE TABLE DATA  */
    }
    
    #statsDiv{
                    display: none;
                    overflow-y: auto;
    }
    
    td.details-control {
                    background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
                    display: block;

    }
    
    tr.shown td.details-control {
                    background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
    }
    
    .desc-text{
          zpadding-left: 20px;
          padding-bottom: 5px;
          zmargin-top: -12px;
          font-size: 18px;
          font-style: italic;
          color: #002878;
    }
    
    #table-desc-text{

    }
    #stat-desc-text{
                    display: none;
    }
    
    
    /* table.dataTable tbody tr:hover {  */
    table.dataTable tbody tr:not(.selected):hover { 
        background-color:#dee1e5 !important;
    }
    
    
    .nvd3 text {
                    font: normal 8px sans-serif !important;
    }
    #chart_FilingStatus{
                    margin: 0px;
                    padding: 0px;
                    height: 100%;
                    width: 100%;
    }
    #chart_BoroCount{
                    margin: 0px;
                    padding: 0px;
                    height: 100%;
                    width: 100%;
    }
    #chart_cdCount{
                    margin: 0px;
                    padding: 0px;
                    height: 100%;
                    width: 100%;
    }
    #chart_FilingDate{
                    margin: 0px;
                    padding: 0px;
                    height: 100%;
                    width: 100%;
    }
    
    
    #loadpage{


    }
    
    
    
    .datatableHeading {
                    font-size: 14px;
    }             
    
    .datatableHeading > dt-buttons{
                    color: green;
    }

    #filingsTable_filter input {
                    margin-left: 0.5em;
                    width: 140px;
    }
    


    td.control::before {
                    content: attr(data-before);
    
    }


    /* override Bootstrap's override of search styling; gives us the X to clear the search text */
    input[type="search"]::-webkit-search-decoration, 
    input[type="search"]::-webkit-search-cancel-button {  
                    -webkit-appearance: searchfield-cancel-button;
    }


    
    td:not(.control) {
                    cursor: pointer;
    }
    
    
    td.control::before, td.control::after, td.control{
                    cursor: default;
    }
    
    .filterTableButton.disabled {
                      border: 1px solid #999999;
                      background-color: #cccccc;
                      color: #666666;
                      cursor: not-allowed;
    }             

    @media screen and (min-width: 0px) {
                    body {
                                    padding-top: 120px;
                    }
    }             
    @media screen and (min-width: 1200px) {
                    body {
                                    padding-top: 70px;
                    }

    }

</style>
 
<body>
<nav class="navbar navbar-default  navbar-fixed-top" style="min-height:50px" >
				<div class="container-fluid">
									<div class="navbar-header">

													<a class=" navbar-brand navbar-link" href="https://www1.nyc.gov/site/buildings/index.page" target="_blank">
																	<img alt="" src="" height="50px" >
													</a>
													<a class="navbar-link" style="text-decoration: none;" href="index_splash.html">
																					<!--  <div class="navbar-text" title="Job Filings Home" style="color:#44a8de; font-size:35px;font-weight:bold;margin:auto 1px;">  -->
																									<span style="color:#44a8de; font-size:35px;font-weight:bold;">
																													DOB NOW Job Filings
																									</span>
																					<!-- </div>  -->
													</a>                                                                     
													<button type="button"  class="navbar-toggle collapsed  " data-toggle="collapse"
													data-target="#collapse-content" title="Menu" aria-expanded="false">
																	<span class="sr-only">Toggle navigation</span>
																	<span class="icon-bar"></span>
																	<span class="icon-bar"></span>
																	<span class="icon-bar"></span>
													</button>
									</div>
									<div class="collapse navbar-collapse"  id="collapse-content">
													<div class="znavbar-right znavbar-link">
																	<div>
																					<a class="znavbar-link navbar-right" href="https://a810-dobnow.nyc.gov/Publish/#!/" target="_blank">
																									<span class="toggleText navbar-text hidden-lg hidden-md hidden-sm mynavlink h4" style="">DOB Build Now</span>
																									<img alt="DOB NOW Build logo" class="visible-lg-inline visible-md-inline visible-sm-inline" src="http://a810-dobnow.nyc.gov/Publish/images/dob_now_build.jpg" height="50px" >
																					</a>
																	</div>
																	<div>
																					<a class="znavbar-link navbar-right" href="https://github.com/NYCDOB/DOB_NOW_Milestone_App/blob/gh-pages/README.md" target="_blank">
																									<span class="toggleText navbar-text mynavlink h4" style="padding-right:50px;">About</span>
																					</a>                                                                                     
																	</div>
																	<!--
																	<div>
																					<a class="znavbar-link navbar-right" href="https://nycdob.github.io/DOB_NOW_Milestone_App/index_overview" target="_blank">
																									<span class="toggleText navbar-text mynavlink h4" style="color:navy;padding-right:50px;">Citywide Filings</span>
																					</a>                                                                                     
																	</div>
																	-->

																	<div>
																					<a class="znavbar-link navbar-right" href="index_splash.html" >
																									<span class="toggleText navbar-text mynavlink h4" style="padding-right:50px;">Home</span>
																					</a>                                                                                     
																	</div>
									</div>
								   
									</div>
				</div>
                </nav>
 
 
 
 
<!--    FILTER SELECTION DIV -->
<div class="zcontainer container-fluid" id="divCriteriaForm" >
                                                <form id="filterForm">
 
 
 
 
<div class="row">
 
		<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"    style="background-color: #f9f9f9;border: 3px solid navy;margin-top: 30px;padding-left:15px;padding:20px 15px;">
<!--        <div class="row" style="zline-height: 10px;border: solid 1px red;margin-top: 30px;">
                                <div class="col-lg-8 col-lg-offset-2" style="font-size: 12px;">Borough, Zip Code, or Community Distict</div>
                </div>
-->			<div class="row text-center" style="font-size:20px;font-weight:700;color:#002878;font-style:italic;">
							Search by Work Type, Geography, and Time Frame
			</div>
					<div class="row" style="margin-top: 30px;">   <!-- WORKTYPE -->
							<div class="col-md-2">
											<label for="worktype"><span style="color:red">*</span>WORK TYPE:</label>
							</div>
							<div class="col-md-10" >
								<select id="dropdownWT"  style="overflow:auto" required> 
												<option value="" selected="true" disabled seleted hidden>Select Work Type...</option>
												<option value="Antenna">Antenna</option>
												<option value="Boiler Equipment">Boiler Equipment</option>
												<option value="Construction Fence">Construction Fence</option>
												<option value="Cranes" disabled>Cranes & Derricks</option>
												<option value="Curb Cut">Curb Cut</option>
												<option value="Electrical" disabled>Electrical</option>
												<option value="Elevator" disabled>Elevator</option>
												<option value="genConst" disabled>General Construction</option>
												<option value="Mechanical Systems">Mechanical Systems</option>
												<option value="Place of Assembly">Place of Assembly</option>                                                                                                                                                                                                                                           
												<option value="Plumbing">Plumbing</option>
												<option value="Supported Scaffold">Supported Scaffold</option>
												<option value="Sidewalk Shed" >Sidewalk Shed</option>
												<option value="Sign">Sign</option>
												<option value="Sprinklers">Sprinklers</option>
												<option value="Standpipe">Standpipe</option>
												<option value="Structural">Structural</option>
												<option value="Temporary Place of Assembly" >Temporary Place of Assembly</option>          
								</select>                            
							</div>
					</div>   <!-- END  WORKTYPE -->
				   

					<div class="row">
									<div class="col-lg-8 col-lg-offset-2 separator">
									</div>
					</div>
		 
		 

		 
						<div class="row" style="margin-top: 30px;"> <!-- geography-->
														<div class="col-md-2 " >
																<label for="geog" title="Borough, Zip, or CD"><span style="color:red;">*</span>WITHIN:</label>
														</div>
														<div class="col-md-3">
																<select id="geochoice" title="Borough, Zip, or CD" >
																								<!--  <option value="null" disabled selected required></option>  -->
																								<option value="geogdivborough"selected >Borough</option>
																								<option value="geogdivcommunitydistrict">Community District</option>
																								<option value="geogdivzipcode">Zip Code</option>
																</select>
														</div>
														<div class="col-md-7 ">
															<div id="geogdivborough" >
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="BRONX" id="bronx" required>Bronx</label>
																			</div>
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="BROOKLYN" id="brooklyn">Brooklyn</label>
																			</div>
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="MANHATTAN" id="manhattan">Manhattan</label>
																			</div>
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="QUEENS" id="queens">Queens</label>
																			</div>
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="STATEN ISLAND" id="statenIsland">Staten Island</label>
																			</div>
																			<div class="radio-inline">
																							<label><input type="radio" name="geogdivborough" value="Citywide" id="citywide" checked>Citywide</label>
																			</div>
															</div>
														<div id="geogdivzipcode" style="display:none" >
																		<input id="zipTxtBox" name="geogdivzipcode" type="text" pattern="[0-9]{5}" size="5"  title="Zipcode (5 digits)" placeholder="5-digit Zip" >
														</div>
														<div  id="geogdivcommunitydistrict" style="display:none" >
																		<select id="dropdownCD"  name="geogdivcommunitydistrict" title="Community District" style="height: auto;max-height: 50px; overflow-x: hidden;">
																						<option value="" disabled selected hidden>Select Community District</option>
																						<option value="Manhattan" disabled>Manhattan</option>
																						<option value="101">101</option>
																						<option value="102">102</option>
																						<option value="103">103</option>
																						<option value="104">104</option>
																						<option value="105">105</option>
																						<option value="106">106</option>
																						<option value="107">107</option>
																						<option value="108">108</option>
																						<option value="109">109</option>
																						<option value="110">110</option>
																						<option value="111">111</option>
																						<option value="112">112</option>
																						<option value="164">164</option>
																						<option value="Bronx" disabled>Bronx</option>
																						<option value="201">201</option>
																						<option value="202">202</option>
																						<option value="203">203</option>
																						<option value="204">204</option>
																						<option value="205">205</option>
																						<option value="206">206</option>
																						<option value="207">207</option>
																						<option value="208">208</option>
																						<option value="209">209</option>
																						<option value="210">210</option>
																						<option value="211">211</option>
																						<option value="212">212</option>
																						<option value="226">226</option>
																						<option value="227">227</option>
																						<option value="228">228</option>
																						<option value="Brooklyn" disabled>Brooklyn</option>
																						<option value="301">301</option>
																						<option value="302">302</option>
																						<option value="303">303</option>
																						<option value="304">304</option>
																						<option value="305">305</option>
																						<option value="306">306</option>
																						<option value="307">307</option>
																						<option value="308">308</option>
																						<option value="309">309</option>
																						<option value="310">310</option>
																						<option value="311">311</option>
																						<option value="312">312</option>
																						<option value="313">313</option>
																						<option value="314">314</option>
																						<option value="315">315</option>
																						<option value="316">316</option>
																						<option value="317">317</option>
																						<option value="318">318</option>
																						<option value="355">355</option>
																						<option value="356">356</option>
																						<option value="Queens" disabled>Queens</option>
																						<option value="401">401</option>
																						<option value="402">402</option>
																						<option value="403">403</option>
																						<option value="404">404</option>
																						<option value="405">405</option>
																						<option value="406">406</option>
																						<option value="407">407</option>
																						<option value="408">408</option>
																						<option value="409">409</option>
																						<option value="410">410</option>
																						<option value="411">411</option>
																						<option value="412">412</option>
																						<option value="413">413</option>
																						<option value="414">414</option>
																						<option value="480">480</option>
																						<option value="481">481</option>
																						<option value="482">482</option>
																						<option value="483">483</option>
																						<option value="484">484</option>
																						<option value="Staten Island" disabled>Staten Island</option>
																						<option value="501">501</option>
																						<option value="502">502</option>
																						<option value="503">503</option>
																						<option value="595">595</option>
																		</select>
														</div>
														</div>
						</div>
					<div class="row" style="">
									<!--<div class="col-lg-8 col-lg-offset-2 visible-lg-block " style="font-size: 12px;">Borough, Zip Code, or Community Distict</div>-->
					</div>
					<div class="row">  <!-- separator -->
							<div class="col-lg-8 col-lg-offset-2 separator">
							</div>
					</div> 
					<div class="row" style="margin-top: 30px;">   <!-- DATE RANGE -->
									<div class="col-lg-2">
													<label for="worktype"><span style="color:red;">*</span>DATE RANGE:</label>
									</div>
									<div class="col-lg-5 datepicker">
													<div class="row">
																	<div class="col-lg-2	"><label for="from">From:</label></div>
																	<div class="col-lg-9"><input type="text" id="from" class="datePicker" name="from" required></div>
													</div>  
									</div>
									<div class="col-lg-5 datepicker">
													<div class="row">
																	<div class="col-lg-2"><label for="to">To:</label></div>
																	<div class="col-lg-9"><input type="text" id="to" class="datePicker" name="to" required></div>
													</div>  
													<!--  <label for="to">To: </label><input type="text" id="to" name="to" class="datePicker" required>   -->
									</div>                                                                                  
					</div>
					<div class="row" style="margin-top:20px;"> <!-- searching / no data found -->
							<span id="loadpage" class="center-block text-center" style="visibility:hidden;height:10px;color:#44a8de;font-weight:700;">Searching...please wait<img id="" style="margin-left:10px;" src="data/Ellipsis-3.4s-50px.gif"/></span>
							<span id="noDataFound" class="center-block text-center" style="visibility:hidden;height:10px;color:red;font-weight:bolder;">No Job Filings Match Selected Criteria</span>
					</div>
					<div class="row">  <!--  separator -->
						<div class="col-lg-1" style="margin-top: 20px;font-size:14px"><span style="color:red;">*</span>Required</div>

					</div>
 
                                               
            </div>
                                               
</div>
<div class="row">
				<button class="center-block btn-dark" id="mapBtn" style="margin-top: 50px;"> Map Data </button>
</div>
                                                                                               
                                                </form>
</div>  <!--   container-fluid  -->
 
 
 
 
 
<!--   END FILTER SELECTION DIV -->
 
 
<!--    MAP AND TABLE DIV  -->
<div class="container-fluid divTableMap" style="display:none;">
	<div class="row">
					<div class="col-lg-3">
									<div class="desc-text" id="table-desc-text">
													Click on a table row to filter and zoom map...
									</div>
									<div class="desc-text" id="stat-desc-text">
													Summary statistics for the Applicant's Job Filings...
									</div>
					</div>									
					<div class="col-lg-9 ">	
						<div class="ztext-center pull-right" id="btnRefineSearch" style="font-size: 18px;font-weight:700;color:red;cursor:pointer;">			
							<span class="glyphicon glyphicon-search" aria-hidden="true"></span> Refine Search
						</div>
					</div>
	</div>
	
	
	<div class="row" >  <!--   toggle TABLE & DATA -->
			<div class="col-lg-3">                                              
							<div class="btn-group btn-group-toggle" data-toggle="buttons" id="btnTableStats" >
												
															<label class="btn btn-dark active" id="btnText">
															<input type="radio" name="options" id="table" value="table" checked=""> Table
															</label>
															<label class="btn btn-dark" id="btnText">
															<input type="radio" name="options" id="stats" value="stats"> Statistics
															</label>
							</div>
			</div>
	</div>
    <div class="row" style="height:800px;overflow:auto;">                       
				<div class="col-lg-3">
								<div id="ui-container" class="ui" style="height:800px;overflow:auto;">
												<h4>Work Type: <b><span id="workTypeValue_txt"></span></b></h4>
												<h4>Geography: <b><span id="geo_txt"></span></b></h4>
												<h4>Time Frame: <b><span id="fromDate_txt"></span></b> - <b><span id="toDate_txt"></span></b></h4>
                        <h4>Total Job Filings: <b><span id="filteredData_txt"></span><span class="datasetmsg" ><sup>*</sup></span></b></h4>
                        <h5 class="datasetmsg"><sup>*</sup><span id="totalresults"></span> filings returned. Only the most recent 2000 are shown. Please narrow down your search criteria.</h5>                        
												<hr>
												<div class="qry" id="tableDiv"> 
														<table id="filingsTable" class="display" style="width:100%;">
																<thead>
																				<tr>
																								<th></th>
																								<th class="">Address</th> 
																								<th class="">Borough:</th>
																								<th class="none">Job Number</th>
																								<th class="none">BIN</th>
																								<th class="none">Work Type:</th>
																								<th class="none">Filing Date:</th>                                                                                                                        
																								<th class="none">Community District:</th>
																				</tr>                                                                                    
																</thead>
														</table>
												</div>
											   
												<div class="qry" id="statsDiv">
																<div id="statsDivFilter">
																</div>
																<h4>Filings per Status (Top 5)</h4>
																<svg id="chart_FilingStatus"></svg>
																<br/>
																<h4>Filings per Borough</h4>
																<svg id="chart_BoroCount"></svg>
																<br/>
																<h4>Filings per Community District (Top 10)</h4>
																<svg id="chart_cdCount"></svg>
												</div>
								</div>
				</div>                  
				<div class="col-lg-9">                 
								<div  id="map-container" >
												<div id="map"></div>
								</div>
				</div>                  
    </div>
</div>
<!--    END  MAP AND TABLE DIV  -->
 
 
<div class="modal" id="helpModal" tabindex="-1" role="dialog" data-keyboard="false">  <!--  help modal   CATHY SIMON  -->
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
	
        <div class="modal-header">
				<!--   <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>   -->
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>				
				<div class="row">
				  <div class="col-md-3"><img src="https://www1.nyc.gov/assets/buildings/images/content/header/logo.png" style="margin: 0px 20px;"></div>
				  <div class="col-md-9"><h1>DOB NOW Job Filings</h1></div>
				</div>
        </div>	
      <div class="modal-body modal-md">
	    <ul class="helpList">
			<li>Filtering</li>
				<ol>
					<li>Select any point on Map to filter the list</li>
					<li>Click the X in the search box to clear all filters</li>
				</ol>
			<li>Getting Details</li>
				<ol>
					<li>Select any point on Map to display information</li>
					<li>Click the <img src="https://datatables.net/examples/resources/details_open.png"></img> icon in the table to display detail information</li>
					<li>Click the <img src="https://datatables.net/examples/resources/details_close.png"></img> icon in the table to close detail information</li>
				</ol>
		</ul>
      </div>
    </div>
  </div>
</div>



 
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="Leaflet.D3SvgOverlay-master/L.D3SvgOverlay.min.js"></script>
<script src='https://code.jquery.com/jquery-3.3.1.js'></script>  <!-- IS INTERFERRING WITH BUTTONS -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="js/topics.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
<script src="https://cdn.datatables.net/v/dt/dt-1.10.12/r-2.1.0/se-1.2.0/datatables.min.js"  type="text/javascript" charset="utf8" ></script>
<script src="build/nv.d3.js"></script>
 
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
 
<script>
 
(function(){
 
//document.querySelector('#from').valueAsDate = new Date();
//document.querySelector('#to').valueAsDate = new Date();
 

document.querySelector("#btnRefineSearch").addEventListener("click", () => {

			//goSearch
		location.reload();

			
			});
			
			
function goSearch() {
												let theform = document.querySelector("#divCriteriaForm");
												theform.style.display="block";                                                               
												theform = document.querySelector("#filterForm");
												theform.style.display="block";

												
	let divTableMap = document.querySelector(".divTableMap");
	divTableMap.style.display="none";
	//divTableMap.style.visibility="hidden";
}


document.querySelector("#geochoice").addEventListener("change", switchGeography);
function switchGeography(){
	document.querySelectorAll("[id*='geogdiv']").forEach(  (item)=>{
		let geochoice = document.querySelector("#geochoice").value;										   
		if (geochoice == item.id) {
				document.querySelector("#"+item.id).style.display="block";
				document.querySelectorAll("*[name='" + item.id + "'] ").forEach(  (el)  =>  {el.required=true;} );
		} else {
				document.querySelector("#"+item.id).style.display="none";
				document.querySelectorAll("*[name='" + item.id + "'] ").forEach(  (el)  =>  {el.required=false;} );
		}
	});
}
 
$.fn.dataTable.Buttons.defaults.dom.button.className = ''; //'btn btn-primary'              
 
 
var map = L.map('map').setView([40.713312, -73.977407], 11);
//L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
var grayscale = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),
                streets = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});
 
grayscale.addTo(map);
 
var baseMaps = {
                "<span style='color:gray'>Grayscale Basemap</span>": grayscale,
                "<span style='color:gray'>Streets Basemap</span>": streets
};
 
L.control.layers(baseMaps).addTo(map);
 
var tooltip = d3.select('body').append('div')
                .on('mouseover', function(d, i){
                                tooltip.transition().duration(0);
                })
                .on('mouseout', function(d, i){
                                tooltip.transition().delay(500).style('visibility', 'hidden');
                })
                .attr('class', 'tooltip');
               
var width = $("#map").width(),
      height = $("#map").height(),
      points = [],
      table_map = [],
      filteredData,
      latlong = [],
      zoomSelect = 15,
      latLngs = [],
      selectedRecord,
	  filteredData=[];
               
var selectionCD,
      selectionText,
      selectionWT,
      workTypeValue,
      boroValue,
      cdValue,
      zipValue,
      fromDate,
      toDate,
      format = d3.time.format("%-m/%-d/%Y").parse,
      //boros = '#bronx, #brooklyn, #manhattan, #queens, #statenIsland, #citywide';
      //selectionWT=document.querySelector("#dropdownWT").value;
      // selectionWT = $('#dropdownWT').val();
      //selectionCD = $('#dropdownCD').val();
      //selectionText = $('#zipTxtBox').val();
	  theGeog;
	  



    /*
                //WORK TYPE
                $('#dropdownWT').change(function() {
                                selectionWT = $('#dropdownWT').val();
        if(selectionWT != 0)
       {
                                                workTypeSelected = 1;
       }
      else
      {
                                workTypeSelected = 0;
        }
                                console.log(selectionWT);
                                //navBtnsWT();
                });
 
 
                //BOROUGHS
                $(boros).click(function(){
        if($(this).is(':checked'))
        {
                                                boroughSelected = 1;
                                                zipSelected = 0;
                                               
        }
        else
        {
                                                boroughSelected = 0;
        }                     
                                //$('#dropdownCD').val(0);
                                //$('#dropdownBoro').val(0);
                                //$('#zipTxtBox').val('');
                                //navBtnsGeo();
    });
                //COMMUNITY DISTRICT
                $('#dropdownCD').change(function() {
                                selectionCD = $('#dropdownCD').val();
                                selectionCD = $('#dropdownCD').val();
        if(selectionCD != 0)
        {
                                                commDistSelected = 1;
                                                boroughSelected = 0;
                                                //addrBoroSelected = 0;              
                                                zipSelected = 0;
        }
        else
        {
                                                commDistSelected = 0;
        }
                                $('input:radio[name=borough]').prop('checked',false);
                                $('#dropdownBoro').val(0);
                                //$('#addy').val('');
                                $('#zipTxtBox').val('');
                                navBtnsGeo();
                });          
 
                //ZIP CODE
                $('#zipTxtBox').keyup (function() {
                                selectionText = $('#zipTxtBox').val();
                                if(selectionText != '')
                                {
                                                zipSelected = 1;
                                                boroughSelected = 0;
                                                commDistSelected = 0;
                                }
                                else
                                {
                                                zipSelected = 0;
                                }             
                                console.log(selectionText);
                                $('#dropdownCD').val(0);
                                $('input:radio[name=borough]').prop('checked',false);
                                navBtnsGeo();
                });
                */
 
 
                //TIME FRAME
                $('.datepicker').change(function() {
                                                fromDate = $('#from').val();
                                                toDate = $('#to').val();

                });
 
                //DATE PICKER
                $( function() {
                var dateFormat = "m-d-yy",
                  from = $( "#from" ).datepicker({
                                  defaultDate: "+1w",
                                  changeMonth: true,
                                  numberOfMonths: 1
                                })
                                .on( "change", function() {
                                  to.datepicker( "option", "minDate", getDate( this ) );
                                }),
                  to = $( "#to" ).datepicker({
                                defaultDate: "+1w",
                                changeMonth: true,
                                numberOfMonths: 1
                  })
                  .on( "change", function() {
                                from.datepicker( "option", "maxDate", getDate( this ) );
                  });
 
                function getDate( element ) {
                  var date;
                  try {
                                date = $.datepicker.parseDate( dateFormat, element.value );
                  } catch( error ) {
                                date = null;
                  }
                  return date;
                }
                });
 
				$("#from").datepicker()
                                .focus(function() {
                                $(this).prop("autocomplete", "off");
                });
                $("#to").datepicker()
                                .focus(function() {
                                $(this).prop("autocomplete", "off");
                });
               
/*
                //FILTERED DATA
                $("#dropdownWT").change(function() {
                                workTypeValue = $("#dropdownWT").val();
                                $('#workTypeValue_txt').text(workTypeValue);
                                $('.workTypeValue_txt').text(workTypeValue); 
                                console.log(workTypeValue);
                });
                $("input[name='geogdivborough']").click(function(){
                                boroValue = $("input[name='geogdivborough']:checked").val();
                                $('#geo_txt').text(boroValue);
                                $('.geo_txt').text(boroValue); 
                                console.log(boroValue);
                });
                $('#dropdownCD').change(function() {
                                cdValue = $('#dropdownCD').val();
                                $('#geo_txt').text('Community District '+cdValue);
                                $('.geo_txt').text('Community District '+cdValue); 
                                console.log(cdValue);
                });
                $('#zipTxtBox').keyup(function() {
                                zipValue = $('#zipTxtBox').val();
                                $('#geo_txt').text(zipValue);
                                $('.geo_txt').text(zipValue);
                                console.log(zipValue);
                });
 
 */
 
 
 
                $('#from').change(function() {
                                fromDate = $('#from').datepicker({ dateFormat: 'm-d-yy' }).val();
                                $('#fromDate_txt').text(fromDate);
                                //$('.fromDate_txt').text(fromDate); 
                                //console.log(fromDate);
                                fromFormatDate = format(fromDate);  
                                //console.log(fromFormatDate);
                });
                $('#to').change(function() {
                                toDate = $('#to').datepicker({ dateFormat: 'm-d-yy' }).val();
                                $('#toDate_txt').text(toDate);
                                //$('.toDate_txt').text(toDate);
                                //console.log(toDate);
                                toFormatDate = format(toDate);
                               // console.log(toFormatDate);
                });
               
 
                function tableStatsAppear(){
                                $('#btnTableStats').show().siblings('div').hide();
                                $('#tableDiv').show().siblings("div").hide();
                }
 
                function loadTable(){
                $(function(){
				var table = $('#filingsTable').DataTable({
												data: filteredData,											   
												'responsive': {
																'details': {
																   'type': 'inline',
																   'target': 0
																}
												},
											   
												columnDefs: [
															{
															   'data': null,
															   'defaultContent': '',
															   'className': 'control',
															   'orderable': false,
															   'targets': 0

															},
															{
																			"targets": 1,
																			"data": null,   //   "address",
																			"render": function ( data, type, row ) {
																											return row.HouseNum+" "+row.Street;
															  }
															}
												],
												  'columns': [
																 { 'data': null }, 
																 { 'data': "address", "className":"parentRow"  },              // this will become address                                                                                               
																 { 'data': "Borough", "className":"parentRow" },  //Borough.0??
															   
																 { 'data': "key_id",
																   'render': function(data,type,row,meta){
																								return '<a href= "https://nycdob.github.io/DOB_NOW_Milestone_App2/index_property#' + data +'" target="_blank">' + data + '</a>';
																}},
																{ 'data': "Bin" },
																{ 'data': "Work Type Name" },
																{ 'data': "Filing Date" },
																{ 'data': "Community Board" }
												  ],
												 
												  
																"dom": 'r<"datatableHeading"Bf>tip',
																"buttons": [
															   
																				// BASIC EXPORT (minified)
																				/*{extend: 'csvHtml5',text: 'Export Data',customize: function(csv){return csv;}},*/
																			   
																			   
																				{ // EXPORT ALL DATA, DISREGARD ANY SEARCH THAT IS APPLIED
																	   
																	   
																						extend: 'csv',
																						titleAttr: 'Download all data to CSV',
																						filename: "MilestoneData",
																						className: "filterTableButton",
																						text: 'Export',
																						exportOptions: {
																										modifier: {
																														search: 'none'
																										},
																						columns: 'th:not(:first-child)'  //we don't need the first column (ie 0)
																						}
																				},
																			   
																			   
																				{ //DEFINE ACTIONS WHEN SELECT 'RESET' BUTTON
																						text: 'Reset',
																						titleAttr: 'Reset Map, Reset All Data',
																						className: "filterTableButton",
																						action: function(e, dt, node, config) {
																									   
																										zoom(latLngs);
																										d3.selectAll('.point').style("fill-opacity", function(d){
																																						return "0.7";
																										});
																									   
																										$("#filingsTable .child ").hide(); 
																										 
																										table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
																																						this.nodes().to$().removeClass( 'selected' );
																																						this.nodes().to$().removeClass( 'parent' );
																																						this.nodes().to$().removeClass( 'child' );
																																						this.child.hide();
																																						this.nodes().to$().removeClass("shown");
																										} );
																									   
																										$(".select-info").empty();                                                                                                                                                                                                                                                                                                                                                                                                                                      
																										table.search("").draw();  //remove all search/filter data
																						}
																				},
																			   
																				{
																								text: 'Help',
																								titleAttr: 'Show Information',
																								action: function(e, dt, node, config) {
																																				$('#helpModal').modal('show');
																																}
																				}

																],                                                                                            

																'lengthChange': false,
																'scrollY': '460px',
																'scrollCollapse': true,
																'paging': false,
																'order': [[1, "asc"]]
								});
								$('#loadpage').hide();


                                                               
                                //  THIS SHOULD JUST HILIGHT AND ZOOM ON THE MAP
                                $('#filingsTable tbody ').on( 'click', "td.parentRow" ,function () {
                                                tdParentRow=$(this).parent();
                                                // console.log(tdParentRow )
                                                $(tdParentRow).toggleClass("selected");
                                               
                                                $(tdParentRow).siblings().removeClass('selected');
 
                                                if ( $(tdParentRow).hasClass('selected') ) {
                                                                                for (var i=0; i < table.rows('.selected').data().length; i++){
                                                                                                selectedRecord = table.rows('.selected').data()[i].Bin;
                                                                                                var lat = table.rows('.selected').data()[i].Latitude;
                                                                                                var lon = table.rows('.selected').data()[i].Longitude;
                                                                                                latlong = [lat,lon];
                                                                                                //console.log(selectedRecord);
                                                                                }
                                                                                highlightPoint(selectedRecord);
                                                                                zoomToSelected(latlong);
                                                } else {
                                                                                d3.selectAll('.point')
                                                                                                .style("fill-opacity", function(d){
                                                                                                                return "0.7";
                                                                                                });
                                                                                zoom(latLngs);
                                                }
                                });
               
                               
                               
                                $('#filingsTable').on( 'click', function (e,LocationBin) {
                                                                if (LocationBin) {
                                                                                table.search( LocationBin).draw();
                                                                }
                                })
                               
 
                });
                };
               
                function highlightPoint(layerID){   //this filters the data on the map , so that only one point is shown
                                console.log(layerID);
                                d3.selectAll(".point")
                                                .style("fill-opacity", function(d){
                                                                if(d.Bin == layerID){return "0.7"}
                                                                else{return "0"};
                                                })
                }
                function zoomToSelected(latlong){
                                                map.setView(latlong,zoomSelect);
                }
               
                function zoom(latLngs){
                                if (latLngs === undefined || latLngs == 0){
                                                window.alert("No results found. Please adjust query criteria");
 
                                                const TABLEX = $('#filingsTable').DataTable();
                                                TABLEX.buttons(0).enable(false);
                                                TABLEX.buttons(1).enable(false);
                                               
                                               
                                }
                                else
                                {
                                                polyline = L.polyline(latLngs,{opacity:0}).addTo(map);
                                                map.fitBounds(polyline.getBounds());                                                  
                                                map.removeLayer(polyline);
                                }
                };
 
/*
 
                var mapDataClick = document.getElementById('mapBtn');
                mapDataClick.onclick = function(){
                                console.log("clicked");
                                mapData();
                                tableStatsAppear();
                                $("#map-container").show().css("display", "block");
                                map.invalidateSize(); // Expands map after div is displayed.
 
 
                                document.querySelector("ui-form").style.dislay="none";
                               
                                $("#desc-text-Time").hide();
                                $("#qryDivTime").hide();
                                $("#prevBtnTime").hide();
                                $("#mapBtn").hide();
                                $("#table-desc-text").show();
                                $("#qry-col").hide();
                                $("#ui-container").show();
                                $("#div_homePageBtn_map").show();
                               
                               
                }
               
*/
 
 
 
                $('input:radio[name="options"]').change(function() {
                                if ($(this).val() === 'stats') {
                                                $("#table-desc-text").hide();
                                                $("#stat-desc-text").show();
                                                $("#tableDiv").hide();
                                                $("#statsDiv").show();
												window.dispatchEvent(new Event("resize"));
                                               
                                                //workaround for "no data available" text being cut off on opening of stats tab vvvvv
                                                var noDataTextElements = document.querySelectorAll(".nv-noData");
                                                noDataTextElements.forEach(function(theNoDataTextElement) {
                                                                theNoDataTextElement.setAttribute("x", "220.5");                                                                                                        
                                                });
												
												
                                                //workaround for "no data available" text being cut off on opening of stats tab ^^^^^
                                               
                                               
                                } else if ($(this).val() === 'table') {
                                                $("#stat-desc-text").hide();
                                                $("#table-desc-text").show();
                                                $("#tableDiv").show();
                                                $("#statsDiv").hide();
                                }
                  });
                 
                  
                  
                  
                  
                function mapData() {

				
										//document.querySelector("#btnRefineSearch").addEventListener("click",return;);
										
										
//										function goSearch() {
//											let theform = document.querySelector("#divCriteriaForm");
//											theform.style.display="block";                                                               
//											theform = document.querySelector("#filterForm");
//											theform.style.display="block";
//																						
//											let divTableMap = document.querySelector(".divTableMap");
//											divTableMap.style.display="none";
//											//divTableMap.style.visibility="hidden";
//										}

				
				
				
				
				
				
				
                                var pointsOverlay = L.d3SvgOverlay(function(sel,proj){
                                var pointsUpd = sel.selectAll('circle').data(points);
                                pointsUpd.enter()
                                                .append('circle')
                                                .attr('cx',function(d){return proj.latLngToLayerPoint(d.latLng).x;})
                                                .attr('cy',function(d){return proj.latLngToLayerPoint(d.latLng).y;})
                                                .attr('class', function(d){
                                                                return "point";
                                                }) 
                                                .on('click', function(d){
                                                                $('#filingsTable').trigger( "click",d.bin   );
                                                                tooltip.style("visibility", "visible");
                                                                tooltip.html(
                                                                                //'JOB NUMBER: ' + '<a href= "https://nycdob.github.io/DOB_NOW_Milestone_App2/index_property#' + d.key_id +'" target="_blank">' + d.jobNum + "</a>" + '</br>' +
                                                                                'JOB NUMBER: ' + '<a href= "index_property.html#' + d.key_id +'" target="_blank">' + d.jobNum + "</a>" + '</br>' +
                                                                                'BIN: ' + d.bin + '</br>' +                                                                                                                              
                                                                                'ADDRESS: '+ d.HouseNum + ' ' + d.Street + ', ' + d.Borough + '</br>' +
                                                                                'COMMUNITY DISTRICT: ' + d.CD + '</br>' +
                                                                                'WORK TYPE: '+ d.workType + '</br>' +
                                                                                'FILING DATE: ' + d["Filing Date"]
                                                                )
                                                                if (d3.event.pageX > (width - 200)) {
                                                                   tooltip.style("left", (d3.event.pageX - 350) + "px");
                                                                } else {
                                                                   tooltip.style("left", (d3.event.pageX + 20) + "px")
                                                                                                .style("top", (d3.event.pageY -30) + "px");
                                                                }
                                                                if (d3.event.pageY > (height - 150)) {
                                                                   tooltip.style("top", (d3.event.pageY -100) + "px");
                                                                } else {
                                                                   tooltip.style("top", (d3.event.pageY -30) + "px");
                                                                }                                                             
                                                })
                                                .on("mouseover", function(d, i){
                                                                if(d3.select(this).style("fill-opacity") != 0){
                                                                                tooltip.transition().duration(0);
                                                                                $(this).attr("style", "cursor: pointer; fill: #eef442; fill-opacity: 1;");           
                                                                }
                                                })
                                                .on("mouseout", function(d, i){
                                                                if(d3.select(this).style("fill-opacity") != 0){
                                                                                $(this).attr("style", "stroke-width: 0px; fill-opacity: .7;");
                                                                                return tooltip.transition().delay(1000).style("visibility", "hidden");
                                                                }
                                                });
                                                pointsUpd.attr('r', 5 / proj.scale);
								});
								
								let withinSelection = document.querySelector("#geochoice").value;
							
                                d3.csv("https://raw.githubusercontent.com/NYCDOB/MA/gh-pages/milestone.csv", function(data){
                                               
                                                data.forEach(function(d){  //column names used for assignment, e.g. "Bin" is col name in csv file
														d.latLng = [+d.Latitude,+d.Longitude];
														//d.bin = [d.Bin];                                                 
														d.bin = d.Bin;                                                 
														d.HouseNum = d["House Number"];
														d.Street = d["Street Name"];
														d.CD = d["Community Board"];
														//d.Borough = [d.Borough.toUpperCase()];
														d.Borough = d.Borough.toUpperCase();
														d.jobNum = d["Job Number"];
														d.workType = d["Work Type Name"];
														//d.key_id = [d.key_id];
														d.key_id = d.key_id;
														d.filingDate = format(d["Filing Date"]);
														d.filingStatus = d["Filing Status"];
														//d.Zip = [d.zip];
														d.Zip = d.zip;
														

														if (  d["Work Type Name"] == selectionWT  && d.filingDate >= fromFormatDate && d.filingDate <= toFormatDate   ) {
																	if (  withinSelection == "geogdivcommunitydistrict"  &&  d["Community Board"] == selectionCD  ) {
																		filteredData.push(d);
																		document.querySelector("#loadpage").firstChild.textContent="Results Found!...Map Loading ";
																		
																	} else if  (withinSelection == "geogdivzipcode"  &&  d.zip == zipValue )  {
																		filteredData.push(d);
																		document.querySelector("#loadpage").firstChild.textContent="Results Found!...Map Loading ";																		
																		
																		
																	} else if (   withinSelection == "geogdivborough"  && ( boroValue == "Citywide"  || [d.Borough] == boroValue  )  ){
																		filteredData.push(d);
																		document.querySelector("#loadpage").firstChild.textContent="Results Found!...Map Loading ";																		
																	}																								
														} 
																																													
                                                });
												
												document.querySelector("#loadpage").style.visibility="hidden";												
												if ( filteredData.length==0 ) {
													document.querySelector("#noDataFound").style.visibility="visible";
													return;
												} else if (filteredData.length > 2000 )	{
													//only show first 2000
                          document.querySelectorAll(".datasetmsg").forEach((el)=> {el.style.display="inline";});
                          document.querySelector("#totalresults").textContent=filteredData.length;
                          filteredData = filteredData.slice(0,2000);
                          
													true;
													
												}
												
												
												
												
												
												
												document.querySelector("#noDataFound").style.visibility="hidden";
												let theform = document.querySelector("#divCriteriaForm");
												theform.style.display="none";                                                               
												theform = document.querySelector("#filterForm");
												theform.style.display="none";												
												let divTableMap = document.querySelector(".divTableMap");
												divTableMap.style.display="block";
												tableStatsAppear();
												
												$("#map-container").show().css("display", "block");
												
												
												/*
			switch (theGeog) {
				  case "geogdivborough": 
							  $('#geo_txt').text(boroValue);
					  break;
				  case "geogdivzipcode":  //#zipTxtBox

						document.querySelector("#geo_txt").textContent=zipValue;
						break;
				  default: //commdistrict #dropdownCD
						document.querySelector("#geo_txt").textContent=selectionCD;
              }
			  												*/
												
												
												map.invalidateSize(); // Expands map after div is displayed.

												$("#table-desc-text").show();
												$("#ui-container").show();
												$("#table-desc-text").show();

												
                                                points = filteredData.map(function(d){
                                                                return d;
                                                });
                                                latLngs = filteredData.map(function(d){                                                               
                                                                return d.latLng;
                                                });
                                                $('#filteredData_txt').text(filteredData.length);
												
												
                                                loadTable();                                                                                              
                                                pointsOverlay.addTo(map);
                                                zoom(latLngs);
 
                                                //clearFilters();
                                                //$('#filingsTable').show(); ********************************************************
                                               
                                                               
                                               
                                                //NESTING FOR SUMMARY STATS
                                                var filingStatusNest = d3.nest()
                                                                .key(function(d) { return d.filingStatus; })
                                                                .rollup(function(v) {
                                                                                return v.length;
                                                                })                                            
                                                                .entries(filteredData)
                                                                .sort(function(a, b){ return d3.descending(a.values, b.values); }).slice(0,5);        
                                                //console.log(filingStatusNest);
                                                filingStatusChart(filingStatusNest);
                                               
                                                var boroughNest = d3.nest()
                                                                .key(function(d) { return d.Borough; })
                                                                .rollup(function(v) {
                                                                                return v.length;
                                                                })                                            
                                                                .entries(filteredData)
                                                                .sort(function(a, b){ return d3.descending(a.values, b.values); });            
                                                //console.log(boroughNest);
                                                boroCountChart(boroughNest);
                                               
                                                var commDistNest = d3.nest()
                                                                .key(function(d) { return d.CD; })
                                                                .rollup(function(v) {
                                                                                return v.length;
                                                                })                                            
                                                                .entries(filteredData)
                                                                .sort(function(a, b){ return d3.descending(a.values, b.values); }).slice(0,10);;     
                                                //console.log(commDistNest);
                                                cdCountChart(commDistNest);
                                               
                                                var filingDateNest = d3.nest()
                                                                .key(function(d) { return d.filingDate; })
                                                                .rollup(function(v) {
                                                                                return v.length;
                                                                })                                            
                                                                .entries(filteredData)    
                                                // console.log(filingDateNest);
                                });   //end of d3.csv reading and processing data
 
                                function filingStatusChart(data){
                                                var exampleData = [
                                                                {
                                                                                key: "totals",
                                                                                values: []
                                                                }
                                                ];
 
                                                                // populate the empty object with your data
                                                data.forEach(function (d){
                                                                d.values = +d.values
                                                                exampleData[0].values.push(d)
                                                })      
 
                                                nv.addGraph(function() {                                                            
                                                                var chart = nv.models.discreteBarChart()
                                                                                .x(function (d) {  return d.key })
                                                                                .y(function (d) { return d.values })
                                                                                .margin({top: 10, right: -10, bottom: -50, left: 20})
                                                                                //.options({height:75, width:400,})
                                                                                .options({height:75})
                                                                                .color(['#E64C00']);
                                                                               
                                                                chart.yAxis.tickFormat(d3.format('.0f'));
                                                                chart.xAxis.tickFormat(function(d){
                                                                    if (typeof this != 'undefined') {
                                                                                var el = d3.select(this);
                                                                                var p = d3.select(this.parentNode);
                                                                                p.append("foreignObject")
                                                                                                .attr('x', -25)
                                                                                                .attr("width", 50)
                                                                                                .attr("height", 200)
                                                                                                .append("xhtml:p")
                                                                                                .attr('style','word-wrap: break-word; text-align:center; font: normal 8px sans-serif;')
                                                                                                .html(d);   
 
                                                                                    el.remove();
                                                                                    return d;
                                                                    }
                                                                });
 
                                                                d3.select('#chart_FilingStatus')
                                                                                                .datum(exampleData)
                                                                                                .attr("id", function (d) { 
																										//console.log(d); 
																										})
                                                                                .transition().duration(500)
                                                                                                .call(chart);
 
                                                                nv.utils.windowResize(chart.update);
                                                                return chart;
                                                });
                                }
                               
                                function boroCountChart(data){
                                                var exampleData = [
                                                                {
                                                                                key: "totals",
                                                                                values: []
                                                                }
                                                ];
 
                                                                // populate the empty object with your data
                                                data.forEach(function (d){
                                                                d.values = +d.values
                                                                exampleData[0].values.push(d)
                                                })      
 
                                                nv.addGraph(function() {                                                            
                                                                var chart = nv.models.discreteBarChart()
                                                                                .x(function (d) { return d.key })
                                                                                .y(function (d) { return d.values })
                                                                                .margin({top: 10, right: -10, bottom: -50, left: 20})
                                                                                //.options({height:75, width:400,})
                                                                                .options({height:75 })
                                                                                .color(['#E64C00']);
                                                                               
                                                                chart.yAxis.tickFormat(d3.format('.0f'));
 
                                                                d3.select('#chart_BoroCount')
                                                                                                .datum(exampleData)
                                                                                                .attr("id", function (d) { //console.log(d);
																								})
                                                                                .transition().duration(500)
                                                                                                .call(chart);
 
                                                                nv.utils.windowResize(chart.update);
                                                                return chart;
                                                });
                                }
                               
                                function cdCountChart(data){
                                                var exampleData = [
                                                                {
                                                                                key: "totals",
                                                                                values: []
                                                                }
                                                ];
 
                                                                // populate the empty object with your data
                                                data.forEach(function (d){
                                                                d.values = +d.values
                                                                exampleData[0].values.push(d)
                                                })      
 
                                                nv.addGraph(function() {                                                            
                                                                var chart = nv.models.discreteBarChart()
                                                                                .x(function (d) { return d.key })
                                                                                .y(function (d) { return d.values })
                                                                                .margin({top: 10, right: -10, bottom: -50, left: 20})            
                                                                                //.options({height:75, width:400,})
                                                                                .options({height:75})
                                                                                .color(['#E64C00']);
 
                                                                chart.yAxis.tickFormat(d3.format('.0f'));
 
                                                                d3.select('#chart_cdCount')
                                                                                                .datum(exampleData)
                                                                                                .attr("id", function (d) { 
																								//console.log(d); 
																								})
                                                                                .transition().duration(500)
                                                                                                .call(chart);
 
                                                                nv.utils.windowResize(chart.update);
                                                                return chart;
                                                });
                                }
                               
                                function filingDateChart(data){
                                                var exampleData = [
                                                                {
                                                                                key: "totals",
                                                                                values: []
                                                                }
                                                ];
 
                                                data.forEach(function (d){
                                                                d.values = +d.values
                                                                exampleData[0].values.push(d)
                                                })
 
                                                nv.addGraph(function() {                                                            
                                                                var chart = nv.models.discreteBarChart()
                                                                                .x(function (d) { console.log(d); return d.key })
                                                                                .y(function (d) { return d.values })
                                                                                .margin({top: 10, right: -10, bottom: -50, left: 20})            
                                                                                //.options({height:75, width:400,})
                                                                                .options({height:75})
                                                                                .color(['#E64C00']);
 
                                                                chart.yAxis.tickFormat(d3.format('.0f'));
 
                                                                d3.select('#chart_cdCount')
                                                                                                .datum(exampleData)
                                                                                                .attr("id", function (d) { console.log(d); })
                                                                                .transition().duration(500)
                                                                                                .call(chart);
 
                                                                nv.utils.windowResize(chart.update);
                                                                return chart;
                                                });
                                }
                                                               
                                map.on('resize', function(){
                                                map.invalidateSize();
                                });  




								
 
                                //function clearFilters(){
                                //                $('#mapBtn').attr('disabled', 'disabled');
                                //                $("#dropdownWT").val('0');
                                //                $("input[name='geogdivborough']").attr('checked', false);
                                //                $('#dropdownCD').val(0);
                                //                $('#zipTxtBox').val('');
                                //                $('#dropdownBoro').val(0);
                                //                $('#from').datepicker('setDate', null);
                                //                $('#to').datepicker('setDate', null);
                                //}
                               
                               
                                //var openingMap = { tableState: $.extend({}, table.api.state()) }
                               
                               
                }
 
                const form = document.querySelector('#filterForm');
 
form.addEventListener('submit', (e) => {
			e.preventDefault();
			document.querySelector("#loadpage").style.visibility="visible";			  
			document.querySelector("#noDataFound").style.visibility="hidden";
			let fieldName = document.querySelector("#dropdownWT");
			selectionWT = fieldName.options[fieldName.selectedIndex].value;
			document.querySelector("#workTypeValue_txt").textContent=selectionWT;
			theGeog = document.querySelector("#geochoice").value;
			switch (theGeog) {
				  case "geogdivborough": 
					  document.querySelectorAll("[name='geogdivborough']").forEach( (item) => {
					  if (item.checked) {
							  boroValue=item.value;
							  
							  document.querySelector("#geo_txt").textContent=boroValue;
					  }});
					  break;
				  case "geogdivzipcode":  //#zipTxtBox
						zipValue=document.querySelector("#zipTxtBox").value;
						document.querySelector("#geo_txt").textContent=zipValue;
						break;
				  default: //commdistrict #dropdownCD
						fieldName = document.querySelector("#dropdownCD");
						selectionCD = fieldName.options[fieldName.selectedIndex].value;
						document.querySelector("#geo_txt").textContent=selectionCD;
              }
			  mapData();
        });  //end Form's event listener 
})()
</script> 
</body>
</html>
 
